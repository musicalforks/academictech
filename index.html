<!--Program including HTML, CSS, Javascript to display data-driven graph visualization from Omeka API data-->
<!DOCTYPE html>
<meta charset="utf-8">
<head><link href="https://fonts.googleapis.com/css?family=Pangolin" rel="stylesheet"></head>


<!--Beginning of CSS stylesheet-->
<style>
	
.link {
	stroke: #000;
}
	
body {
	font-family: 'Pangolin', cursive;
    font-size: 15px;
      }

.node text {
  pointer-events: none;
  font: 10px 'Pangolin';
}
	
.themes {}
.orgs {}
.center {}

</style>

<!--Beginning of body and JavaScript/D3 program-->
<body>
<script src="https://d3js.org/d3.v3.js"></script>
<script>

//Initialize svg with gray background and physics model for visualization	
var width = window.innerWidth - 20;
    height = window.innerHeight - 25;

var svg = d3.select("body").append("svg")
    .attr("width", width)
    .attr("height", height);

svg.append("rect")
      //.attr("xlink:href", "https://www.beautycolorcode.com/cdcdcd.png")
      .attr("x", 0)
      .attr("y", 0)
	  .attr("fill", "#ccc")
      .attr("width", width)
      .attr("height", height);

var force = d3.layout.force()
    .gravity(0.01)
    .distance(140)
    .charge(-900)
    .size([width, height]);

//Stores dicts representing themes and orgs to display as nodes	
var nodes = [];
//Stores links between themes and orgs
var links = [];
//Stores names of themes
var themeList = [];
var numThemes = 0;
	
/*Complete API requests, format resulting JSON to usable data, and visualize the data*/
	
//Send API requests for theme data (GET all tags) and format resulting JSON
d3.json("http://neatline.celestesharpe.com/api/tags?pretty_print", function(data1) {
	//Send API requests for org data (GET all items of Organization Item type) and format resulting JSON
	d3.json("http://neatline.celestesharpe.com/api/items/?item_type=18", function(data2){
		d3.json("http://neatline.celestesharpe.com/api/items/?item_type=19", function(data3){
     
	  /*Formatting API JSON returns to correct data format*/
	  //Get themes (GET all tags) and put into list
	  for (var i = 0; i < data1.length; i++){
		var tag = data1[i].name;	
		themeList.push(tag);
	  }
	  numThemes = data1.length;
	  //Create dict for each theme and add to nodes
	  for (var i = 0; i < themeList.length; i++){	
		var themeDict = {};
		themeDict = {"id": i, "name": themeList[i], "level": "0", "themes": [themeList[i]]};
		nodes.push(themeDict);
	  }
			  
			  
	  //GET all items of Organization Item Type, and create dict for each org and add to nodes
	  for (var j = 0; j < data2.length; j++){
		  var name = data2[j].element_texts[0].text;
		  var url = data2[j].element_texts[1].text;
		  var logo = data2[j].element_texts[2].text;
		  var themes = [];
		  //For loop to add themes key as a list of themes (tags related to org)
		  //And to add links between themes and org by id
		  for (var k = 0; k < data2[j].tags.length; k++){
			  themes.push(data2[j].tags[k].name);
			  //Find the theme id
			  var l = 0;
			  while(data2[j].tags[k].name != themeList[l]){
				  l++
			  }
			  var link = {"source": j+numThemes, "target": l, "value": 1}
			  links.push(link);
		  }
		  var orgDict = {};
		  orgDict = {"id": j+numThemes, "name": name, "level": "1", "logo": logo, "url": url, "themes": themes};
		  nodes.push(orgDict);
	  }
	  var oldj = j;	
		
	  //Add proj title node
	  for (var j = 0; j < data3.length; j++){
		  var name = data3[j].element_texts[1].text;
		  var url = data3[j].element_texts[0].text;
		  var themes = [];
		  for (var k = 0; k < data3[j].tags.length; k++){
			  themes.push(data3[j].tags[k].name);
			  //Find the theme id
			  var l = 0;
			  while(data3[j].tags[k].name != themeList[l]){
				  l++
			  }
			  var link = {"source": oldj+numThemes, "target": l, "value": 1}
			  links.push(link);
		  }
	  }
	  var orgDict = {};
	  orgDict = {"id": oldj+numThemes, "name": name, "level": "2", "url": url, "themes": themes};
	  nodes.push(orgDict);  
		
			  
	   /*Begin displaying data stored by nodes and links in visualization*/
	   force
      .nodes(nodes)
      .links(links)
      .start();

  //Display links using links list		
  var link = svg.selectAll(".link")
      .data(links)
    .enter().append("line")
      .attr("class", "link");
  
  //Select and class nodes using nodes list
  var node = svg.selectAll(".node")
      .data(nodes)
      .enter().append("g")
      .attr("class", "node")
      //Class nodes by theme/org class type
  	  .attr("class", isThemeOrOrg)
      .call(force.drag);
	
	//Display theme nodes as circle colored by theme color and captioned by theme name
  	var themes = svg.selectAll(".themes")
	  themes.append("circle")
      .attr("r", 40)
      .attr("fill", circleColour)
	  themes.append("text")
      .text(function(d) { return d.name })
	  .attr("text-anchor", "middle");

	//Display org nodes as logo image with hyperlink to org's Collection page
  	var orgs = svg.selectAll(".orgs")
	  orgs.append("image")
      .attr("xlink:href", function(d){return d.logo})
      .attr("x", -8)
      .attr("y", -8)
      .attr("width", 30)
      .attr("height", 30);
	  orgs.append("a")
      .attr("xlink:href", function(d){return d.url})
	  .append("rect")
	  .attr("y", -6)
      .attr("x", -8)
      .attr("width", 30) //2*4.5)
      .attr("height", 30)
	  .style("fill-opacity", .0000000000001);
			  
	//Display center node
  	var center = svg.selectAll(".center")
	  .append("a")
      .attr("xlink:href", function(d){return d.url})
	  center.append("circle")
      .attr("r", 55)
      .attr("fill", "#aaa")
	  center.append("text")
      .text(function(d) { return d.name })
	  .attr("text-anchor", "middle");

			  
/*Function to determine if node is theme or org*/	
function isThemeOrOrg(d){
	if (d.level == "0"){
		return "themes";
	}else if (d.level == "1"){
		return "orgs";
	}else{
		return "center";
	}
}
	
/*Function to determine theme node's color
  Green: ecological education, blue: human rights, purple: urban planning, red: ecofeminism
  yellow: new media, orange*/
function circleColour(d){
	console.log(d);
	if(d.themes[0] =="ecological education"){
		return d3.rgb(179, 232, 156);
	} else if (d.themes[0] =="human rights"){
		return d3.rgb(118, 202, 228);
	} else if (d.themes[0] =="urban planning"){
		return d3.rgb(154, 126, 191);
	} else if (d.themes[0] =="ecofeminism"){
		return d3.rgb(255, 153, 153);
	} else if (d.themes[0] =="new media"){
		return d3.rgb(255, 255, 153);
	} else if (d.themes[0] =="migration"){
		return d3.rgb(255, 178, 102);
	}
}	
  //Complete drawing all items on svg
  force.on("tick", function() {
    link.attr("x1", function(d) { return d.source.x; })
        .attr("y1", function(d) { return d.source.y; })
        .attr("x2", function(d) { return d.target.x; })
        .attr("y2", function(d) { return d.target.y; });
    //Visualization is responsive to user input (dragging nodes)
    node.attr("transform", function(d) { return "translate(" + d.x + "," + d.y + ")"; });
  });
	
	});
});
});
</script>